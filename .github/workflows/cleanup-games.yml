name: Cleanup Old Games

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run cleanup script
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          FIREBASE_DB_URL: ${{ secrets.FIREBASE_DB_URL }}
        run: |
          npm install firebase-admin
          node -e "
            const admin = require('firebase-admin');
            const serviceAccount = JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT);

            admin.initializeApp({
              credential: admin.credential.cert(serviceAccount),
              databaseURL: process.env.FIREBASE_DB_URL
            });

            const db = admin.database();
            const cutoff = Date.now() - (30 * 24 * 60 * 60 * 1000); // 30 days

            db.ref('games').once('value').then(snapshot => {
              const deletions = [];
              snapshot.forEach(game => {
                if (game.val().config?.createdAt < cutoff) {
                  console.log('Deleting:', game.key);
                  deletions.push(game.ref.remove());
                }
              });
              return Promise.all(deletions);
            }).then(results => {
              console.log('Deleted', results.length, 'games');
              process.exit(0);
            }).catch(err => {
              console.error(err);
              process.exit(1);
            });
          "
